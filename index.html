
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Controle 365</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#f2f4f7;--panel:#fff;--panel-alt:#f7f9fc;--accent:#0066ff;--accent-hover:#0056d4;--danger:#d92d20;--text:#111827;--text-muted:#6b7280;--border:#d1d5db;--radius:8px}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif}
body{background:var(--bg);color:var(--text);padding:20px;display:flex;justify-content:center;font-size:15px}
.wrapper{width:100%;max-width:960px}
.container{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:18px}
h2{font-size:1.3rem;font-weight:600;margin-bottom:14px}

/* ---------- FORM ---------- */
.form-grid{display:grid;gap:10px;grid-template-columns:2fr 1fr;grid-template-areas:
  "desc value"
  "method date"
  ". button";}
#desc{grid-area:desc}
#value{grid-area:value}
#method{grid-area:method}
#opDate{grid-area:date}
#addBtn{grid-area:button;padding:12px;border:none;border-radius:var(--radius);background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
.form-grid input,.form-grid select{padding:10px;border:1px solid var(--border);border-radius:var(--radius);font-size:.9rem;width:100%}
#addBtn:hover{background:var(--accent-hover)}

/* ---------- TABLE ---------- */
.table-wrapper{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.82rem;margin-top:10px}
thead th{background:var(--panel-alt);padding:6px;font-weight:600;text-align:left}
th,td{border:1px solid var(--border);padding:6px;vertical-align:top;word-wrap:anywhere}
tr.month-header{background:var(--panel-alt);cursor:pointer}
tr.month-header.closed{background:#e9ecf3}
td.saldo-neg{background:#fdeaea}
td.negative{color:#b42318;font-weight:600}
td.positive{color:#027a48;font-weight:600}

/* lines */
.op-line{display:flex;align-items:center;justify-content:space-between;gap:6px}
.op-txt{display:flex;gap:6px;flex:1}
button.icon{background:none;border:none;font-size:1rem;color:var(--text-muted);padding:0 2px;cursor:pointer}
button.icon:hover{color:var(--accent-hover)}button.icon.danger:hover{color:var(--danger)}
.op-ts{font-size:.68rem;color:var(--text-muted);margin-left:20px}

/* mobile tweaks */
@media(max-width:480px){
  .container {
    padding: 16px;
  }
  .form-grid {
    grid-template-columns:1fr;
    grid-template-areas:
      "desc"
      "value"
      "method"
      "date"
      "button";
    gap: 14px;
  }
  .form-grid input,
  .form-grid select {
    font-size: 1rem;
    padding: 14px;
  }
  #addBtn {
    width: 100%;
    height: 48px;
    font-size: 1rem;
    margin-top: 8px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  }

  .container{padding:14px}
  /* form single column */
  .form-grid{grid-template-columns:1fr;grid-template-areas:
    "desc" "value" "method" "date" "button"}
  #addBtn{width:100%}
  /* hide gastos col */
  th:nth-child(3),td:nth-child(3){display:none}
  th:nth-child(1),td:nth-child(1){width:68px}
  th:nth-child(4),td:nth-child(4){width:88px}
  th,td{padding:4px}
  /* two-line text with icons aligned */
  .op-line{align-items:flex-start}
  .op-txt{flex-direction:column}
  .op-txt .value{font-size:.8rem}
}

/* misc */
button.danger{background:var(--danger);color:#fff}button.danger:hover{opacity:.9}
details.invoice summary{cursor:pointer;list-style:none}
details.invoice summary::before{content:'‚ñ∏';margin-right:4px}
details.invoice[open] summary::before{transform:rotate(90deg)}
.invoice{background:var(--panel-alt);padding:6px;border-radius:var(--radius);margin-bottom:4px}
small{color:var(--text-muted);font-size:.75rem}
</style>

<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
<link rel="manifest" href="site.webmanifest">

</head>
<body>
<div class="wrapper">
  <div class="container">
    <h2>Lan√ßar opera√ß√£o</h2>
    <div class="form-grid">
      <input id="desc" placeholder="Descri√ß√£o">
      <input id="value" type="number" placeholder="Valor (- despesa)">
      <select id="method"></select>
      <input id="opDate" type="date">
      <button id="addBtn">Adicionar</button>
    </div>
  </div>

  <div class="container">
    <details><summary>Gerenciar cart√µes</summary>
      <div style="margin-top:10px">
        <div class="form-grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:6px">
          <input id="cardName" placeholder="Nome">
          <input id="cardClose" type="number" min="1" max="31" placeholder="Fech">
          <input id="cardDue" type="number" min="1" max="31" placeholder="Venc">
          <button id="addCardBtn">Adicionar</button>
        </div>
        <small>Fechamento define a fatura.</small>
        <ul id="cardList" style="margin-top:8px"></ul>
      </div>
    </details>
  </div>

  <div class="container">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px" id="startGroup">
      <label for="startInput">Saldo inicial:</label>
      <input id="startInput" type="number" style="flex:1">
      <button id="setStartBtn" style="flex:0 0 60px">OK</button>
    </div>
    <div class="table-wrapper">
      <table id="dailyTable"><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Gasto</th><th>Saldo</th></tr></thead><tbody></tbody></table>
    </div>
    <button id="resetData" class="danger" style="margin-top:12px">Limpar TODOS</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

const firebaseConfig={apiKey:"AIzaSyATGZtBlnSPnFtVgTqJ_E0xmBgzLTmMkI0",authDomain:"gastosweb-e7356.firebaseapp.com",databaseURL:"https://gastosweb-e7356-default-rtdb.firebaseio.com",projectId:"gastosweb-e7356",storageBucket:"gastosweb-e7356.firebasestorage.app",messagingSenderId:"519966772782",appId:"1:519966772782:web:9ec19e944e23dbe9e899bf"};
const app=initializeApp(firebaseConfig);const db=getDatabase(app);const PATH='orcamento365_9b8e04c5';
const auth = getAuth(app);
await signInAnonymously(auth);   // garante auth.uid antes dos gets/sets
const save=(k,v)=>set(ref(db,`${PATH}/${k}`),v);const load=async(k,d)=>{const s=await get(ref(db,`${PATH}/${k}`));return s.exists()?s.val():d;};

let transactions=[],cards=[],startBalance=null;
const $=id=>document.getElementById(id);
const tbody=document.querySelector('#dailyTable tbody');

const currency=v=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const meses=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const mobile=()=>window.innerWidth<=480;
const fmt=d=>d.toLocaleDateString('pt-BR',mobile()?{day:'2-digit',month:'2-digit'}:{day:'2-digit',month:'2-digit',year:'numeric'});
const post=(iso,m)=>{if(m==='dinheiro')return iso;const c=cards.find(x=>x.name===m);if(!c)return iso;const [y,mo,d]=iso.split('-').map(Number);let mm=mo,yy=y;if(d>c.close){mm++;if(mm===13){mm=1;yy++;}}return yy+'-'+String(mm).padStart(2,'0')+'-'+String(c.due).padStart(2,'0');};

const desc=$('desc'),val=$('value'),met=$('method'),date=$('opDate'),addBtn=$('addBtn');
const cardName=$('cardName'),cardClose=$('cardClose'),cardDue=$('cardDue'),addCardBtn=$('addCardBtn'),cardList=$('cardList');
const startGroup=$('startGroup'),startInput=$('startInput'),setStartBtn=$('setStartBtn'),resetBtn=$('resetData');

function refreshMethods(){met.innerHTML='';cards.forEach(c=>{const o=document.createElement('option');o.value=c.name;o.textContent=c.name;met.appendChild(o);});}
function renderCardList(){cardList.innerHTML='';cards.filter(c=>c.name!=='dinheiro').forEach(c=>{const li=document.createElement('li');li.textContent=`${c.name} (${c.close}/${c.due})`;const del=document.createElement('button');del.className='icon danger';del.textContent='üóë';del.onclick=()=>{if(confirm('Excluir cart√£o?')){cards=cards.filter(x=>x.name!==c.name);save('cards',cards);refreshMethods();renderCardList();renderTable();}};li.appendChild(del);cardList.appendChild(li);});}
const makeLine=t=>{const d=document.createElement('div');d.className='op-line';const txt=document.createElement('div');txt.className='op-txt';txt.innerHTML=`<span>${t.desc}</span><span class="value">${currency(t.val)}</span>`;d.appendChild(txt);const e=document.createElement('button');e.className='icon';e.textContent='‚úèÔ∏è';e.onclick=()=>editTx(t.id);const del=document.createElement('button');del.className='icon danger';del.textContent='üóë';del.onclick=()=>delTx(t.id);d.appendChild(e);d.appendChild(del);return d;};

function addCard(){const n=cardName.value.trim(),cl=+cardClose.value,du=+cardDue.value;if(!n||cl<1||cl>31||du<1||du>31||cl>=du||cards.some(c=>c.name===n)){alert('Dados inv√°lidos');return;}cards.push({name:n,close:cl,due:du});save('cards',cards);refreshMethods();renderCardList();cardName.value='';cardClose.value='';cardDue.value='';}
function addTx(){const d=desc.value.trim(),v=parseFloat(val.value),m=met.value,iso=date.value;if(!d||isNaN(v)||!iso){alert('Complete os campos');return;}transactions.push({id:Date.now(),desc:d,val:v,method:m,opDate:iso,postDate:post(iso,m),ts:new Date().toISOString()});save('tx',transactions);desc.value='';val.value='';date.value=new Date().toISOString().slice(0,10);renderTable();}
const delTx=id=>{if(!confirm('Apagar?'))return;transactions=transactions.filter(t=>t.id!==id);save('tx',transactions);renderTable();};
const editTx=id=>{const t=transactions.find(x=>x.id===id);if(!t)return;const nd=prompt('Descri√ß√£o',t.desc);if(nd===null)return;const nv=parseFloat(prompt('Valor',t.val));if(isNaN(nv))return;t.desc=nd.trim();t.val=nv;save('tx',transactions);renderTable();};

function renderTable(){
  tbody.innerHTML='';
  const y=new Date().getFullYear();const cur=new Date().getMonth();let saldo=startBalance||0;
  for(let m=0;m<12;m++){
    const hdr=document.createElement('tr');hdr.className='month-header';hdr.dataset.m=m;if(m<cur)hdr.classList.add('closed');
    const td=document.createElement('td');td.colSpan=4;td.textContent=meses[m];hdr.appendChild(td);
    hdr.onclick=()=>{const hide=hdr.classList.toggle('closed');document.querySelectorAll(`tr[data-mon='${m}']`).forEach(r=>r.style.display=hide?'none':'table-row');};
    tbody.appendChild(hdr);
    for(let d=1;d<=31;d++){
      const date=new Date(y,m,d);if(date.getMonth()!==m)break;
      const iso=date.toISOString().slice(0,10);const dayTx=transactions.filter(t=>t.postDate===iso);const sum=dayTx.reduce((s,t)=>s+t.val,0);saldo+=sum;
      const row=document.createElement('tr');row.dataset.mon=m;row.style.display=m<cur?'none':'table-row';
      row.innerHTML=`<td>${fmt(date)}</td><td></td><td></td><td${saldo<0?' class="saldo-neg"':''}>${currency(saldo)}</td>`;
      const tdD=row.children[1],tdG=row.children[2];
      if(sum!==0){tdG.textContent=currency(sum);tdG.className=sum<0?'negative':'positive';}
      dayTx.filter(t=>t.method==='dinheiro').forEach(t=>tdD.appendChild(makeLine(t)));
      const grp={};dayTx.filter(t=>t.method!=='dinheiro').forEach(t=>(grp[t.method]=grp[t.method]||[]).push(t));
      Object.keys(grp).forEach(card=>{const det=document.createElement('details');det.className='invoice';const sm=document.createElement('summary');sm.textContent='Fatura '+card;det.appendChild(sm);grp[card].forEach(t=>{det.appendChild(makeLine(t));const ts=document.createElement('div');ts.className='op-ts';ts.textContent=t.ts.slice(5,16).replace('T',' ');det.appendChild(ts);});tdD.appendChild(det);});
      tbody.appendChild(row);
    }
  }
}

function initStart(){startGroup.style.display=startBalance===null?'flex':'none';}
setStartBtn.onclick=()=>{const v=parseFloat(startInput.value);if(isNaN(v)){alert('Valor inv√°lido');return;}startBalance=v;save('startBal',v);initStart();renderTable();};
resetBtn.onclick=()=>{if(!confirm('Resetar tudo?'))return;transactions=[];cards=[{name:'dinheiro',close:0,due:0}];startBalance=null;save('tx',transactions);save('cards',cards);save('startBal',null);refreshMethods();renderCardList();initStart();renderTable();};
addCardBtn.onclick=addCard;addBtn.onclick=addTx;

(async()=>{transactions=await load('tx',[]);cards=await load('cards',[{name:'dinheiro',close:0,due:0}]);if(!cards.some(c=>c.name==='dinheiro'))cards.unshift({name:'dinheiro',close:0,due:0});startBalance=await load('startBal',null);refreshMethods();renderCardList();initStart();date.value=new Date().toISOString().slice(0,10);renderTable();})();
</script>
</body>
</html>